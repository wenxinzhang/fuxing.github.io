<!DOCTYPE HTML>
<html lang="zh-CN">

<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="福星">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="http://zhangfuxin.cn">
    <!--SEO-->

<meta name="keywords" content="Hive">


<meta name="description" content="** Hive学习之路 （十）Hive的高级操作：** &lt;Excerpt in index | 首页摘要&gt;
​        Hive学习之路 （十）Hive的高级操作

&lt;T...">


<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->

<title>
    
    Hive学习之路 （十）Hive的高级操作 |
    
    福星
</title>

<link rel="alternate" href="/atom.xml" title="福星" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">

    

<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">
    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>




    

<script>
(function() {
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

</head></html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  style="background-image:url(
    http://snippet.shenliyang.com/img/banner.jpg)"
     >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='福 星'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://zhangfuxin.cn">
                        福星</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Linux/"><i class="fa "></i>
                                Linux</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Hadoop/"><i class="fa "></i>
                                Hadoop</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Spark/"><i class="fa "></i>
                                Spark</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Java/"><i class="fa "></i>
                                Java</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Python/"><i class="fa "></i>
                                Python</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/algorithm/"><i class="fa "></i>
                                算法</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/工具/"><i class="fa "></i>
                                工具</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa "></i>
                                时间轴</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Hive学习之路 （十）Hive的高级操作">
            
            Hive学习之路 （十）Hive的高级操作
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/Hive/">Hive</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
            <a class="tag-link" href="/tags/Hive/">Hive</a>
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2019/05/10</span>
    </span>
    
    <span class="fa-wrap">
        <i class="fa fa-eye"></i>
        <span id="busuanzi_value_page_pv"></span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <p>** Hive学习之路 （十）Hive的高级操作：** &lt;Excerpt in index | 首页摘要&gt;</p>
<p>​        Hive学习之路 （十）Hive的高级操作</p>
<a id="more"></a>
<p>&lt;The rest of contents | 余下全文&gt;</p>
<h2 id="一、负责数据类型"><a href="#一、负责数据类型" class="headerlink" title="一、负责数据类型"></a>一、负责数据类型</h2><h3 id="1、array"><a href="#1、array" class="headerlink" title="1、array"></a>1、array</h3><p> 现有数据如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 huangbo guangzhou,xianggang,shenzhen a1:30,a2:20,a3:100 beijing,112233,13522334455,500</span><br><span class="line">2	xuzheng	xianggang	b2:50,b3:40	tianjin,223344,13644556677,600</span><br><span class="line">3	wangbaoqiang	beijing,zhejinag	c1:200	chongqinjg,334455,15622334455,20</span><br></pre></td></tr></table></figure>

<p>建表语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="keyword">class</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> cdt(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>, </span><br><span class="line"><span class="keyword">name</span> <span class="keyword">string</span>, </span><br><span class="line">work_location <span class="built_in">array</span>&lt;<span class="keyword">string</span>&gt;, </span><br><span class="line">piaofang <span class="keyword">map</span>&lt;<span class="keyword">string</span>,<span class="built_in">bigint</span>&gt;, </span><br><span class="line">address <span class="keyword">struct</span>&lt;location:<span class="keyword">string</span>,zipcode:<span class="built_in">int</span>,phone:<span class="keyword">string</span>,<span class="keyword">value</span>:<span class="built_in">int</span>&gt;) </span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> </span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\t"</span> </span><br><span class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">","</span> </span><br><span class="line"><span class="keyword">map</span> <span class="keyword">keys</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">":"</span> </span><br><span class="line"><span class="keyword">lines</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408173043585-1275161000.png" alt="img"></p>
<p>导入数据</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop3:10000&gt; load data local inpath "/home/hadoop/cdt.txt" into table cdt;</span><br></pre></td></tr></table></figure>

<p>查询语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> cdt;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408183049458-1912277812.png" alt="img"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> cdt;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408183202688-414846691.png" alt="img"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> work_location <span class="keyword">from</span> cdt;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408183336575-889255211.png" alt="img"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> work_location[<span class="number">0</span>] <span class="keyword">from</span> cdt;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408183446633-233162014.png" alt="img"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> work_location[<span class="number">1</span>] <span class="keyword">from</span> cdt;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408183519651-594024573.png" alt="img"></p>
<h3 id="2、map"><a href="#2、map" class="headerlink" title="2、map"></a>2、map</h3><p>建表语句、导入数据同1</p>
<p>查询语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> piaofang <span class="keyword">from</span> cdt;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408183748427-1339156513.png" alt="img"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> piaofang[<span class="string">"a1"</span>] <span class="keyword">from</span> cdt;</span><br></pre></td></tr></table></figure>

<p> <img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408183858137-827620470.png" alt="img"></p>
<h3 id="3、struct"><a href="#3、struct" class="headerlink" title="3、struct"></a>3、struct</h3><p>建表语句、导入数据同1</p>
<p>查询语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> address <span class="keyword">from</span> cdt;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408184016402-1457666185.png" alt="img"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> address.location <span class="keyword">from</span> cdt;</span><br></pre></td></tr></table></figure>

<p> <img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408184050383-1588329051.png" alt="img"></p>
<h3 id="4、uniontype"><a href="#4、uniontype" class="headerlink" title="4、uniontype"></a>4、uniontype</h3><p>很少使用</p>
<p>参考资料：<a href="http://yugouai.iteye.com/blog/1849192" target="_blank" rel="noopener">http://yugouai.iteye.com/blog/1849192</a></p>
<h2 id="二、视图"><a href="#二、视图" class="headerlink" title="二、视图"></a>二、视图</h2><h3 id="1、Hive-的视图和关系型数据库的视图区别"><a href="#1、Hive-的视图和关系型数据库的视图区别" class="headerlink" title="1、Hive 的视图和关系型数据库的视图区别"></a>1、Hive 的视图和关系型数据库的视图区别</h3><p>和关系型数据库一样，Hive 也提供了视图的功能，不过请注意，Hive 的视图和关系型数据库的数据还是有很大的区别：</p>
<p>　　（1）只有逻辑视图，没有物化视图；</p>
<p>　　（2）视图只能查询，不能 Load/Insert/Update/Delete 数据；</p>
<p>　　（3）视图在创建时候，只是保存了一份元数据，当查询视图的时候，才开始执行视图对应的 那些子查询</p>
<h3 id="2、Hive视图的创建语句"><a href="#2、Hive视图的创建语句" class="headerlink" title="2、Hive视图的创建语句"></a>2、Hive视图的创建语句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> view_cdt <span class="keyword">as</span> <span class="keyword">select</span> * <span class="keyword">from</span> cdt;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408184549702-1005718852.png" alt="img"></p>
<h3 id="3、Hive视图的查看语句"><a href="#3、Hive视图的查看语句" class="headerlink" title="3、Hive视图的查看语句"></a>3、Hive视图的查看语句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> views;</span><br><span class="line">desc view_cdt;<span class="comment">-- 查看某个具体视图的信息</span></span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408184741330-1744317581.png" alt="img"></p>
<h3 id="4、Hive视图的使用语句"><a href="#4、Hive视图的使用语句" class="headerlink" title="4、Hive视图的使用语句"></a>4、Hive视图的使用语句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> view_cdt;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408184854110-707403466.png" alt="img"></p>
<h3 id="5、Hive视图的删除语句"><a href="#5、Hive视图的删除语句" class="headerlink" title="5、Hive视图的删除语句"></a>5、Hive视图的删除语句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">view</span> view_cdt;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408185042082-261986868.png" alt="img"></p>
<h2 id="三、函数"><a href="#三、函数" class="headerlink" title="三、函数"></a>三、函数</h2><h3 id="1、内置函数"><a href="#1、内置函数" class="headerlink" title="1、内置函数"></a>1、内置函数</h3><p>具体可看<a href="http://www.cnblogs.com/qingyunzong/p/8744593.html" target="_blank" rel="noopener">http://www.cnblogs.com/qingyunzong/p/8744593.html</a></p>
<h4 id="（1）查看内置函数"><a href="#（1）查看内置函数" class="headerlink" title="（1）查看内置函数"></a>（1）查看内置函数</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> functions;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408185346738-551528669.png" alt="img"></p>
<h4 id="（2）显示函数的详细信息"><a href="#（2）显示函数的详细信息" class="headerlink" title="（2）显示函数的详细信息"></a>（2）显示函数的详细信息</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc function substr;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408185504054-1979368578.png" alt="img"></p>
<h4 id="（3）显示函数的扩展信息"><a href="#（3）显示函数的扩展信息" class="headerlink" title="（3）显示函数的扩展信息"></a>（3）显示函数的扩展信息</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc function extended substr;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180408185612437-1436305025.png" alt="img"></p>
<h3 id="2、自定义函数UDF"><a href="#2、自定义函数UDF" class="headerlink" title="2、自定义函数UDF"></a>2、自定义函数UDF</h3><p>当 Hive 提供的内置函数无法满足业务处理需要时，此时就可以考虑使用用户自定义函数。</p>
<p><strong>UDF</strong>（user-defined function）作用于单个数据行，产生一个数据行作为输出。（数学函数，字 符串函数）</p>
<p><strong>UDAF</strong>（用户定义聚集函数 User- Defined Aggregation Funcation）：接收多个输入数据行，并产 生一个输出数据行。（count，max）</p>
<p><strong>UDTF</strong>（表格生成函数 User-Defined Table Functions）：接收一行输入，输出多行（explode）</p>
<h3 id="1-简单UDF示例"><a href="#1-简单UDF示例" class="headerlink" title="(1) 简单UDF示例"></a>(1) 简单UDF示例</h3><h4 id="A-导入hive需要的jar包，自定义一个java类继承UDF，重载-evaluate-方法"><a href="#A-导入hive需要的jar包，自定义一个java类继承UDF，重载-evaluate-方法" class="headerlink" title="A.　导入hive需要的jar包，自定义一个java类继承UDF，重载 evaluate 方法"></a>A.　导入hive需要的jar包，自定义一个java类继承UDF，重载 evaluate 方法</h4><p>ToLowerCase.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.UDF;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToLowerCase</span> <span class="keyword">extends</span> <span class="title">UDF</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 必须是 public，并且 evaluate 方法可以重载</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">evaluate</span><span class="params">(String field)</span> </span>&#123;</span><br><span class="line">    String result = field.toLowerCase();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="B-打成-jar-包上传到服务器"><a href="#B-打成-jar-包上传到服务器" class="headerlink" title="B.　打成 jar 包上传到服务器"></a>B.　打成 jar 包上传到服务器</h4><h4 id="C-将-jar-包添加到-hive-的-classpath"><a href="#C-将-jar-包添加到-hive-的-classpath" class="headerlink" title="C.　将 jar 包添加到 hive 的 classpath"></a>C.　将 jar 包添加到 hive 的 classpath</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add JAR /home/hadoop/udf.jar;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180414105512185-1132423466.png" alt="img"></p>
<h4 id="D-创建临时函数与开发好的-class-关联起来"><a href="#D-创建临时函数与开发好的-class-关联起来" class="headerlink" title="D.　创建临时函数与开发好的 class 关联起来"></a>D.　创建临时函数与开发好的 class 关联起来</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop3:10000&gt; create temporary function tolowercase as 'com.study.hive.udf.ToLowerCase';</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180414105730255-1712623480.png" alt="img"></p>
<h4 id="E-至此，便可以在-hql-在使用自定义的函数"><a href="#E-至此，便可以在-hql-在使用自定义的函数" class="headerlink" title="E.　至此，便可以在 hql 在使用自定义的函数"></a>E.　至此，便可以在 hql 在使用自定义的函数</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop3:10000&gt; select tolowercase('HELLO');</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180414105920517-647807254.png" alt="img"></p>
<h3 id="2-JSON数据解析UDF开发"><a href="#2-JSON数据解析UDF开发" class="headerlink" title="(2) JSON数据解析UDF开发"></a>(2) JSON数据解析UDF开发</h3><p>现有原始 json 数据（rating.json）如下</p>
<blockquote>
<p>{“movie”:”1193”,”rate”:”5”,”timeStamp”:”978300760”,”uid”:”1”}</p>
<p>{“movie”:”661”,”rate”:”3”,”timeStamp”:”978302109”,”uid”:”1”}</p>
<p>{“movie”:”914”,”rate”:”3”,”timeStamp”:”978301968”,”uid”:”1”}</p>
<p>{“movie”:”3408”,”rate”:”4”,”timeStamp”:”978300275”,”uid”:”1”}</p>
<p>{“movie”:”2355”,”rate”:”5”,”timeStamp”:”978824291”,”uid”:”1”}</p>
<p>{“movie”:”1197”,”rate”:”3”,”timeStamp”:”978302268”,”uid”:”1”}</p>
<p>{“movie”:”1287”,”rate”:”5”,”timeStamp”:”978302039”,”uid”:”1”}</p>
<p>{“movie”:”2804”,”rate”:”5”,”timeStamp”:”978300719”,”uid”:”1”}</p>
<p>{“movie”:”594”,”rate”:”4”,”timeStamp”:”978302268”,”uid”:”1”}</p>
</blockquote>
<p>现在需要将数据导入到 hive 仓库中，并且最终要得到这么一个结果：</p>
<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180414110149949-679183333.png" alt="img"></p>
<p>该怎么做、？？？（提示：可用内置 get_json_object 或者自定义函数完成）</p>
<h4 id="A-get-json-object-string-json-string-string-path"><a href="#A-get-json-object-string-json-string-string-path" class="headerlink" title="A.　get_json_object(string json_string, string path)"></a>A.　get_json_object(string json_string, string path)</h4><p>返回值: string  </p>
<p>说明：解析json的字符串json_string,返回path指定的内容。如果输入的json字符串无效，那么返回NULL。  这个函数每次只能返回一个数据项。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop3:10000&gt; select get_json_object('&#123;"movie":"594","rate":"4","timeStamp":"978302268","uid":"1"&#125;','$.movie');</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180414111001588-234254636.png" alt="img"></p>
<p>创建json表并将数据导入进去</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop3:10000&gt; create table json(data string);</span><br><span class="line">No rows affected (0.983 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop3:10000&gt; load data local inpath '/home/hadoop/json.txt' into table json;</span><br><span class="line">No rows affected (1.046 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop3:10000&gt;</span><br></pre></td></tr></table></figure>

<p> <img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180414111449488-1854085883.png" alt="img"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop3:10000&gt; select </span><br><span class="line">. . . . . . . . . . . . . . .&gt; get_json_object(data,'$.movie') as movie </span><br><span class="line">. . . . . . . . . . . . . . .&gt; from json；</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180414111805847-1824092036.png" alt="img"></p>
<h4 id="B-json-tuple-jsonStr-k1-k2-…"><a href="#B-json-tuple-jsonStr-k1-k2-…" class="headerlink" title="B.　json_tuple(jsonStr, k1, k2, …)"></a>B.　json_tuple(jsonStr, k1, k2, …)</h4><p>参数为一组键k1，k2……和JSON字符串，返回值的元组。该方法比 <code>get_json_object</code> 高效，因为可以在一次调用中输入多个键</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop3:10000&gt; select </span><br><span class="line">. . . . . . . . . . . . . . .&gt;   b.b_movie,</span><br><span class="line">. . . . . . . . . . . . . . .&gt;   b.b_rate,</span><br><span class="line">. . . . . . . . . . . . . . .&gt;   b.b_timeStamp,</span><br><span class="line">. . . . . . . . . . . . . . .&gt;   b.b_uid   </span><br><span class="line">. . . . . . . . . . . . . . .&gt; from json a </span><br><span class="line">. . . . . . . . . . . . . . .&gt; lateral view json_tuple(a.data,&apos;movie&apos;,&apos;rate&apos;,&apos;timeStamp&apos;,&apos;uid&apos;) b as b_movie,b_rate,b_timeStamp,b_uid;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180414113012552-2019392285.png" alt="img"></p>
<h3 id="3-Transform实现"><a href="#3-Transform实现" class="headerlink" title="(3) Transform实现"></a>(3) Transform实现</h3><p>Hive 的 TRANSFORM 关键字提供了在 SQL 中调用自写脚本的功能。适合实现 Hive 中没有的 功能又不想写 UDF 的情况</p>
<p>具体以一个实例讲解。</p>
<p>Json 数据： {“movie”:”1193”,”rate”:”5”,”timeStamp”:”978300760”,”uid”:”1”}</p>
<p>需求：把 timestamp 的值转换成日期编号</p>
<p>1、先加载 rating.json 文件到 hive 的一个原始表 rate_json</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> rate_json(line <span class="keyword">string</span>) <span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span>;</span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/home/hadoop/rating.json'</span> <span class="keyword">into</span> <span class="keyword">table</span> rate_json;</span><br></pre></td></tr></table></figure>



<p>2、创建 rate 这张表用来存储解析 json 出来的字段：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> rate(movie <span class="built_in">int</span>, rate <span class="built_in">int</span>, unixtime <span class="built_in">int</span>, userid <span class="built_in">int</span>) <span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span></span><br><span class="line"><span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br></pre></td></tr></table></figure>



<p>解析 json，得到结果之后存入 rate 表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> rate <span class="keyword">select</span></span><br><span class="line">get_json_object(line,<span class="string">'$.movie'</span>) <span class="keyword">as</span> moive,</span><br><span class="line">get_json_object(line,<span class="string">'$.rate'</span>) <span class="keyword">as</span> rate,</span><br><span class="line">get_json_object(line,<span class="string">'$.timeStamp'</span>) <span class="keyword">as</span> unixtime,</span><br><span class="line">get_json_object(line,<span class="string">'$.uid'</span>) <span class="keyword">as</span> userid</span><br><span class="line"><span class="keyword">from</span> rate_json;</span><br></pre></td></tr></table></figure>



<p>3、使用 transform+python 的方式去转换 unixtime 为 weekday</p>
<p>先编辑一个 python 脚本文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">########python######代码</span></span><br><span class="line"><span class="comment">## vi weekday_mapper.py</span></span><br><span class="line"><span class="comment">#!/bin/python</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> sys.stdin:</span><br><span class="line"> line = line.strip()</span><br><span class="line"> movie,rate,unixtime,userid = line.split(<span class="string">'\t'</span>)</span><br><span class="line"> weekday = datetime.datetime.fromtimestamp(float(unixtime)).isoweekday()</span><br><span class="line"> <span class="keyword">print</span> <span class="string">'\t'</span>.join([movie, rate, str(weekday),userid])</span><br></pre></td></tr></table></figure>

<p>保存文件 然后，将文件加入 hive 的 classpath：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hive&gt;add file /home/hadoop/weekday_mapper.py;</span><br><span class="line">hive&gt; insert into table lastjsontable select transform(movie,rate,unixtime,userid)</span><br><span class="line">using 'python weekday_mapper.py' as(movie,rate,weekday,userid) from rate;</span><br></pre></td></tr></table></figure>



<p>创建最后的用来存储调用 python 脚本解析出来的数据的表：lastjsontable</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> lastjsontable(movie <span class="built_in">int</span>, rate <span class="built_in">int</span>, <span class="keyword">weekday</span> <span class="built_in">int</span>, userid <span class="built_in">int</span>) <span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span></span><br><span class="line"><span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br></pre></td></tr></table></figure>

<p>最后查询看数据是否正确</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span>(<span class="keyword">weekday</span>) <span class="keyword">from</span> lastjsontable;</span><br></pre></td></tr></table></figure>

<h2 id="四、特殊分隔符处理"><a href="#四、特殊分隔符处理" class="headerlink" title="四、特殊分隔符处理"></a>四、特殊分隔符处理</h2><p>补充：hive 读取数据的机制：</p>
<p>1、 首先用 InputFormat&lt;默认是：org.apache.hadoop.mapred.TextInputFormat &gt;的一个具体实 现类读入文件数据，返回一条一条的记录（可以是行，或者是你逻辑中的“行”）</p>
<p>2、 然后利用 SerDe&lt;默认：org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe&gt;的一个具体 实现类，对上面返回的一条一条的记录进行字段切割</p>
<p>Hive 对文件中字段的分隔符默认情况下只支持单字节分隔符，如果数据文件中的分隔符是多 字符的，如下所示：</p>
<p>01||huangbo</p>
<p>02||xuzheng</p>
<p>03||wangbaoqiang</p>
<h3 id="1、使用RegexSerDe正则表达式解析"><a href="#1、使用RegexSerDe正则表达式解析" class="headerlink" title="1、使用RegexSerDe正则表达式解析"></a>1、使用RegexSerDe正则表达式解析</h3><p>创建表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t_bi_reg(<span class="keyword">id</span> <span class="keyword">string</span>,<span class="keyword">name</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> serde <span class="string">'org.apache.hadoop.hive.serde2.RegexSerDe'</span></span><br><span class="line"><span class="keyword">with</span> serdeproperties(<span class="string">'input.regex'</span>=<span class="string">'(.*)\\|\\|(.*)'</span>,<span class="string">'output.format.string'</span>=<span class="string">'%1$s %2$s'</span>)</span><br><span class="line"><span class="keyword">stored</span> <span class="keyword">as</span> textfile;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180414113909764-1659213834.png" alt="img"></p>
<p>导入数据并查询</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0: jdbc:hive2://hadoop3:10000&gt; load data local inpath '/home/hadoop/data.txt' into table t_bi_reg;</span><br><span class="line">No rows affected (0.747 seconds)</span><br><span class="line">0: jdbc:hive2://hadoop3:10000&gt; select a.* from t_bi_reg a;</span><br></pre></td></tr></table></figure>

<p><img src="https://images2018.cnblogs.com/blog/1228818/201804/1228818-20180414114100544-189365287.png" alt="img"></p>

    </div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="https://github.com/wenxinzhang" target="_blank">福星</a>
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    <a href="/2019-05-11-Hive学习之路 （十一）Hive的5个面试题.html" class="pre-post btn btn-default" title='Hive学习之路 （十一）Hive的5个面试题'>
        <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
        <span class="hidden-xs">
            Hive学习之路 （十一）Hive的5个面试题</span>
    </a>
    
    
    <a href="/2019-05-08-Hive学习之路 （八）Hive中文乱码.html" class="next-post btn btn-default" title='Hive学习之路 （八）Hive中文乱码'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            Hive学习之路 （八）Hive中文乱码</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    

<div id="vcomments" class="valine"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>
<script>
new Valine({
    av: AV,
    el: '#vcomments',
    appId: 'UckE9LEIQ8aoa3MH1Kio27rB-gzGzoHsz',
    appKey: '7HC9xCVYQdshKqFRDmULFm5G',
    placeholder: '说点什么吧',
    notify: false,
    verify: true,
    avatar: 'mm',
    meta: 'nick,mail'.split(','),
    pageSize: '10',
    path: window.location.pathname,
    lang: 'zh-CN'.toLowerCase()
})
</script>


</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、负责数据类型"><span class="toc-text">一、负责数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、array"><span class="toc-text">1、array</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、map"><span class="toc-text">2、map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、struct"><span class="toc-text">3、struct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、uniontype"><span class="toc-text">4、uniontype</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、视图"><span class="toc-text">二、视图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、Hive-的视图和关系型数据库的视图区别"><span class="toc-text">1、Hive 的视图和关系型数据库的视图区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、Hive视图的创建语句"><span class="toc-text">2、Hive视图的创建语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、Hive视图的查看语句"><span class="toc-text">3、Hive视图的查看语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4、Hive视图的使用语句"><span class="toc-text">4、Hive视图的使用语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5、Hive视图的删除语句"><span class="toc-text">5、Hive视图的删除语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、函数"><span class="toc-text">三、函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、内置函数"><span class="toc-text">1、内置函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#（1）查看内置函数"><span class="toc-text">（1）查看内置函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（2）显示函数的详细信息"><span class="toc-text">（2）显示函数的详细信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#（3）显示函数的扩展信息"><span class="toc-text">（3）显示函数的扩展信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、自定义函数UDF"><span class="toc-text">2、自定义函数UDF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-简单UDF示例"><span class="toc-text">(1) 简单UDF示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#A-导入hive需要的jar包，自定义一个java类继承UDF，重载-evaluate-方法"><span class="toc-text">A.　导入hive需要的jar包，自定义一个java类继承UDF，重载 evaluate 方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#B-打成-jar-包上传到服务器"><span class="toc-text">B.　打成 jar 包上传到服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#C-将-jar-包添加到-hive-的-classpath"><span class="toc-text">C.　将 jar 包添加到 hive 的 classpath</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#D-创建临时函数与开发好的-class-关联起来"><span class="toc-text">D.　创建临时函数与开发好的 class 关联起来</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#E-至此，便可以在-hql-在使用自定义的函数"><span class="toc-text">E.　至此，便可以在 hql 在使用自定义的函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-JSON数据解析UDF开发"><span class="toc-text">(2) JSON数据解析UDF开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#A-get-json-object-string-json-string-string-path"><span class="toc-text">A.　get_json_object(string json_string, string path)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#B-json-tuple-jsonStr-k1-k2-…"><span class="toc-text">B.　json_tuple(jsonStr, k1, k2, …)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Transform实现"><span class="toc-text">(3) Transform实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、特殊分隔符处理"><span class="toc-text">四、特殊分隔符处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、使用RegexSerDe正则表达式解析"><span class="toc-text">1、使用RegexSerDe正则表达式解析</span></a></li></ol></li></ol>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
    访问量:
    <strong id="busuanzi_value_site_pv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    &nbsp; | &nbsp;
    访客数:
    <strong id="busuanzi_value_site_uv">
        <i class="fa fa-spinner fa-spin"></i>
    </strong>
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2018
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/js/app.js?rev=@@hash"></script>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"right","width":200,"height":350},"mobile":{"show":true}});</script></body>
</html>